/**
 * Taller textntags - Mentions with jQuery
 * @name taller-textntags
 * @version v0.2.0
 * @link https://github.com/TallerWebSolutions/taller-textntags
 * @license MIT
 */
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.TokenParser=e()}}(function(){return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(){function transformObjectPropertiesFn(keys_map){return function(obj,localToPublic){var new_obj={};return localToPublic?_.each(keys_map,function(v,k){new_obj[v]=obj[k]}):_.each(keys_map,function(v,k){new_obj[k]=obj[v]}),new_obj}}var $=window.$,_=window._,isWebkit=/webkit/.test(navigator.userAgent.toLowerCase()),KEY={V:86,Z:90,BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188,SPACE:32,HOME:36,END:35,DELETE:46},defaultSettings={onDataRequest:$.noop,realValOnSubmit:!0,triggers:{"@":{}},templates:{wrapper:_.template('<div class="textntags-wrapper"></div>'),beautifier:_.template('<div class="textntags-beautifier"><div></div></div>'),tagHighlight:_.template('<strong class="<%= class_name %>"><span>$<%= idx %></span></strong>'),tagList:_.template('<div class="textntags-tag-list"></div>'),tagsListItem:_.template("<li><%= title %></li>"),tagsListItemImage:_.template('<img src="<%= img %>" />'),tagsListItemIcon:_.template('<div class="icon <%= no_img_class %>"></div>')}},trigger_defaults={minChars:2,uniqueTags:!0,showImageOrIcon:!0,keys_map:{id:"id",title:"name",description:"",img:"avatar",no_img_class:"icon",type:"type"},syntax:_.template("@[[<%= id %>:<%= type %>:<%= title %>]]"),parser:/(@)\[\[(\d+):([\w\s\.\-]+):([\w\s@\.,-\/#!$%\^&\*;:{}=\-_`~()]+)\]\]/gi,parserGroups:{id:2,type:3,title:4},classes:{tagsDropDown:"",tagActiveDropDown:"active",tagHighlight:""}},transformObjectProperties=_.memoize(transformObjectPropertiesFn),utils={htmlEncode:function(str){return _.escape(str)},highlightTerm:function(value,term){return term||term.length?value.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+term+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>"):value},setCaratPosition:function(domNode,caretPos){if(domNode.createTextRange){var range=domNode.createTextRange();range.move("character",caretPos),range.select()}else domNode.selectionStart?(domNode.focus(),domNode.setSelectionRange(caretPos,caretPos)):domNode.focus()}},TextNTags=function(editor){function setSettings(options){return null!=settings?!1:(options.triggers&&delete defaults.triggers["@"],settings=$.extend(!0,{},defaults,options),delete settings.triggers[""],_.each(settings.triggers,function(val,key){if(settings.triggers[key]=$.extend(!0,{},trigger_defaults,val),!settings.triggers[key].finder){var regex_key=REGEX_ESCAPE_CHARS.indexOf(key)>-1?"\\"+key:key;settings.triggers[key].finder=new RegExp(regex_key+"\\w+(\\s+\\w+)?\\s?$","gi")}}),templates=settings.templates,!0)}function initTextarea(){elEditor=$(editor).bind({click:onEditorClick,keydown:onEditorKeyDown,keypress:onEditorKeyPress,keyup:onEditorKeyUp,input:onEditorInput,blur:onEditorBlur}),elContainer=elEditor.wrapAll($(templates.wrapper())).parent(),settings.realValOnSubmit&&elEditor.closest("form").bind("submit.textntags",function(){elContainer.css("visibility","hidden"),elEditor.val(getTaggedText())})}function initTagList(){elTagList=$(templates.tagList()),elTagList.appendTo(elContainer),elTagList.delegate("li","click",onTagListItemClick)}function initBeautifier(){elBeautifier=$(templates.beautifier()),elBeautifier.prependTo(elContainer)}function initState(){var text_with_tags=getEditorValue(),initialState=parseTaggedText(text_with_tags);if(tagsCollection=initialState.tagsCollection,elEditor.val(initialState.plain_text),updateBeautifier(),tagsCollection.length>0){var addedTags=_.uniq(_.map(tagsCollection,function(tagPos){return tagPos[3]}));elEditor.trigger("tagsAdded.textntags",[addedTags])}}function getEditorValue(){return elEditor.val()}function getBeautifiedText(tagged_text){var beautified_text=tagged_text||getTaggedText();return beautified_text=beautified_text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),_.each(settings.triggers,function(trigger){var markup=templates.tagHighlight({idx:trigger.parserGroups.title,class_name:trigger.classes.tagHighlight});beautified_text=beautified_text.replace(trigger.parser,markup)}),beautified_text=beautified_text.replace(/\n/g,"<br />&shy;"),beautified_text=beautified_text.replace(/ {2}/g," &nbsp;")+"&shy;"}function getTaggedText(){var tagged_text,plain_text=getEditorValue(),position=0,triggers=settings.triggers;return tagged_text=_.map(tagsCollection,function(tagPos){var diff_pos=tagPos[0]-position,diff_text=diff_pos>0?plain_text.substr(position,diff_pos):"",objPropTransformer=transformObjectProperties(triggers[tagPos[2]].keys_map),tagText=triggers[tagPos[2]].syntax(objPropTransformer(tagPos[3],!1));return position=tagPos[0]+tagPos[1],diff_text+tagText}),tagged_text.join("")+plain_text.substr(position)}function parseTaggedText(tagged_text){if(0==_.isString(tagged_text))return null;var plain_text=""+tagged_text,tagsColl=[],triggers=settings.triggers;return _.each(triggers,function(opts,tchar){for(var found_tag,found_len,part_len,parts=tagged_text.split(opts.parser),idx=0,pos=0,len=parts.length,max_group=_.max(opts.parserGroups);len>idx;)parts[idx]==tchar?(found_tag={},_.each(opts.parserGroups,function(v,k){found_tag[opts.keys_map[k]]=parts[idx+v-1],"title"==k&&(found_len=parts[idx+v-1].length)}),tagsColl.push([pos,found_len,tchar,found_tag]),part_len=found_len,idx+=max_group):(part_len=parts[idx].length,idx+=1),pos+=part_len}),tagsColl=_.sortBy(tagsColl,function(tagPos){return tagPos[0]}),_.each(triggers,function(opts){plain_text=plain_text.replace(opts.parser,"$"+opts.parserGroups.title)}),{plain_text:plain_text,tagged_text:tagged_text,tagsCollection:tagsColl}}function updateBeautifier(){elBeautifier.find("div").html(getBeautifiedText()),elEditor.css("height",elBeautifier.outerHeight()+"px")}function checkForTrigger(look_ahead){look_ahead=look_ahead||0;var found_trigger,selectionStartFix=isWebkit?0:-1,sStart=elEditor[0].selectionStart+selectionStartFix,left_text=elEditor.val().substr(0,sStart+look_ahead),found_trigger_char=null,query="";left_text&&left_text.length&&(found_trigger=_.find(settings.triggers,function(trigger,tchar){var matches=left_text.match(trigger.finder);return matches?(found_trigger_char=tchar,query=matches[0].substr(tchar.length),!0):!1}),!found_trigger_char||found_trigger&&query.length<found_trigger.minChars?hideTagList():(currentDataQuery=query,currentTriggerChar=found_trigger_char,_.defer(_.bind(searchTags,this,currentDataQuery,found_trigger_char))))}function onEditorClick(){checkForTrigger(0)}function onEditorKeyDown(e){var keys=KEY,sStart=elEditor[0].selectionStart,sEnd=elEditor[0].selectionEnd,plain_text=elEditor.val();switch(editorSelectionLength=sEnd-sStart,editorTextLength=plain_text.length,editorKeyCode=e.keyCode,e.keyCode){case keys.UP:case keys.DOWN:if(!elTagList.is(":visible"))return!0;var elCurrentTagListItem=null;return elCurrentTagListItem=e.keyCode==keys.DOWN?elTagListItemActive&&elTagListItemActive.length?elTagListItemActive.next():elTagList.find("li").first():elTagListItemActive&&elTagListItemActive.length?elTagListItemActive.prev():elTagList.find("li").last(),selectTagListItem(elCurrentTagListItem,settings.triggers[currentTriggerChar].classes.tagActiveDropDown),!1;case keys.RETURN:case keys.TAB:return elTagListItemActive&&elTagListItemActive.length?(editorAddingTag=!0,elTagListItemActive.click(),!1):!0;case keys.BACKSPACE:case keys.DELETE:return e.keyCode==keys.BACKSPACE&&sStart==sEnd&&sStart>0&&(sStart-=1),sEnd>sStart&&(removeTagsInRange(sStart,sEnd),shiftTagsPosition(sStart,sStart-sEnd)),!0;case keys.LEFT:case keys.RIGHT:case keys.HOME:case keys.END:_.defer(function(){checkForTrigger.call(this,0)});break;case keys.V:e.ctrlKey&&(editorInPasteMode=!0,editorPasteStartPosition=sStart,editorPasteCutCharacters=sEnd-sStart,removeTagsInRange(sStart,sEnd));break;case keys.Z:if(e.ctrlKey)return!1}return!0}function onEditorKeyPress(e){e.keyCode==KEY.RETURN&&updateBeautifier(elEditor.val()),editorAddingTag&&((e.keyCode==KEY.RETURN||e.keyCode==KEY.TAB)&&e.preventDefault(),editorAddingTag=!1)}function onEditorKeyUp(){if(editorInPasteMode){if(editorInPasteMode=!1,editorSelectionLength>0)return;var sEnd=(elEditor[0].selectionStart,elEditor[0].selectionEnd);shiftTagsPosition(editorPasteStartPosition,sEnd-editorPasteStartPosition-editorPasteCutCharacters),updateBeautifier()}}function onEditorInput(){var selectionStartFix=isWebkit?0:-1;if(editorKeyCode!=KEY.BACKSPACE&&editorKeyCode!=KEY.DELETE)if(editorSelectionLength>0){var sStart=elEditor[0].selectionStart+selectionStartFix,selectionLength=editorSelectionLength,sEnd=sStart+selectionLength,tags_shift_positions=elEditor.val().length-editorTextLength;removeTagsInRange(sStart,sEnd),shiftTagsPosition(sEnd,tags_shift_positions)}else if(!editorInPasteMode){var sStart=elEditor[0].selectionStart+selectionStartFix,sEnd=elEditor[0].selectionEnd+selectionStartFix,selectionLength=sEnd-sStart;editorKeyCode==KEY.RETURN?(shiftTagsPosition(sStart-1,1),removeTagsInRange(sStart,sStart)):(shiftTagsPosition(sStart,1),removeTagsInRange(sStart,sStart+1))}updateBeautifier(),checkForTrigger(1)}function onEditorBlur(){_.delay(hideTagList,100)}function hideTagList(){elTagListItemActive=null,elTagList.hide().empty()}function onTagListItemClick(){return addTag($(this).data("tag")),!1}function removeTagsInRange(start,end){var removedTags=[];tagsCollection=_.filter(tagsCollection,function(tagPos){var s=tagPos[0],e=s+tagPos[1],inRange=s>=start&&end>s||e>start&&end>=e||start>s&&e>end;return inRange&&removedTags.push(tagPos[3]),!inRange}),removedTags.length>0&&elEditor.trigger("tagsRemoved.textntags",[removedTags])}function shiftTagsPosition(afterPosition,position_shift){tagsCollection=_.map(tagsCollection,function(tagPos){return tagPos[0]>=afterPosition&&(tagPos[0]+=position_shift),tagPos})}function addTag(tag){var trigger=settings.triggers[currentTriggerChar],objPropTransformer=transformObjectProperties(trigger.keys_map),localTag=objPropTransformer(tag,!1),plain_text=getEditorValue(),sStart=elEditor[0].selectionStart,tagStart=sStart-currentTriggerChar.length-currentDataQuery.length,newCaretPosition=tagStart+localTag.title.length,left_text=plain_text.substr(0,tagStart),right_text=plain_text.substr(sStart),new_text=left_text+localTag.title+right_text;shiftTagsPosition(sStart,newCaretPosition-sStart),tag[trigger.keys_map.id]=""+tag[trigger.keys_map.id],tagsCollection.push([tagStart,localTag.title.length,currentTriggerChar,tag]),tagsCollection=_.sortBy(tagsCollection,function(t){return t[0]}),currentTriggerChar="",currentDataQuery="",hideTagList(),elEditor.val(new_text),updateBeautifier(),elEditor.focus(),utils.setCaratPosition(elEditor[0],newCaretPosition),elEditor.trigger("tagsAdded.textntags",[[tag]])}function selectTagListItem(tagItem,class_name){tagItem&&tagItem.length?(tagItem.addClass(class_name),tagItem.siblings().removeClass(class_name),elTagListItemActive=tagItem):(elTagListItemActive.removeClass(class_name),elTagListItemActive=null)}function populateTagList(query,triggerChar,results){var trigger=settings.triggers[triggerChar];if(trigger.uniqueTags){var id_key=trigger.keys_map.id,tagIds=_.map(tagsCollection,function(tagPos){return tagPos[3][id_key]});results=_.reject(results,function(item){return _.include(tagIds,""+item[id_key])})}if(results.length){var tagsDropDown=$("<ul />").addClass(trigger.classes.tagsDropDown).appendTo(elTagList),imgOrIconTpl=trigger.showImageOrIcon?templates.tagsListItemImage:templates.tagsListItemIcon,objPropTransformer=transformObjectProperties(trigger.keys_map);_.each(results,function(tag,index){var tagItem,localTag=objPropTransformer(tag,!1);localTag.title=utils.highlightTerm(utils.htmlEncode(localTag.title),query),tagItem=$(templates.tagsListItem(localTag)).data("tag",tag),localTag.img&&(tagItem=tagItem.prepend(imgOrIconTpl(localTag))),tagItem.appendTo(tagsDropDown),0===index&&selectTagListItem(tagItem,trigger.classes.tagActiveDropDown)}),elTagList.show()}}function searchTags(query,triggerChar){hideTagList(),settings.onDataRequest.call(this,"search",query,triggerChar,function(responseData){populateTagList(query,triggerChar,responseData)})}var templates,elContainer,elEditor,elBeautifier,elTagList,elTagListItemActive,tagsCollection,currentTriggerChar,currentDataQuery,settings=null,editorSelectionLength=0,editorTextLength=0,editorKeyCode=0,editorAddingTag=!1,editorInPasteMode=!1,editorPasteStartPosition=0,editorPasteCutCharacters=0,REGEX_ESCAPE_CHARS=["[","^","$",".","|","?","*","+","(",")","\\"],defaults=$.extend(!0,{},defaultSettings);return{init:function(options){setSettings(options)&&(initTextarea(),initTagList(),initBeautifier(),initState())},val:function(callback){if(_.isString(callback)){var removedTags=_.uniq(_.map(tagsCollection,function(tagPos){return tagPos[3]}));return elEditor.trigger("tagsRemoved.textntags",[removedTags]),elEditor.val(callback),void initState()}if(_.isFunction(callback)){var value=tagsCollection.length?getTaggedText():getEditorValue();callback.call(this,value)}},reset:function(){var removedTags=_.uniq(_.map(tagsCollection,function(tagPos){return tagPos[3]}));elEditor.trigger("tagsRemoved.textntags",[removedTags]),elEditor.val(""),tagsCollection=[],updateBeautifier()},getTags:function(callback){if(_.isFunction(callback)){var tags=_.map(tagsCollection,function(tagPos){return tagPos[3]});callback.call(this,_.uniq(tags))}},getTagsMap:function(callback){_.isFunction(callback)&&callback.call(this,tagsCollection)},getTagsMapFacebook:function(callback){if(_.isFunction(callback)){var fbTagsCollection={},triggers=settings.triggers;_.each(tagsCollection,function(tagPos){var objPropTransformer=transformObjectProperties(triggers[tagPos[2]].keys_map),localTag=objPropTransformer(tagPos[3],!1);fbTagsCollection[tagPos[0]]=[{id:localTag.id,name:localTag.title,type:localTag.type,offset:tagPos[0],length:tagPos[1]}]}),callback.call(this,fbTagsCollection)}},parseTaggedText:function(tagged_text,callback){_.isFunction(callback)&&callback.call(this,parseTaggedText(tagged_text))}}};$.fn.textntags=function(methodOrSettings){var outerArguments=arguments;return this.each(function(){var ms=methodOrSettings,instance=$.data(this,"textntags")||$.data(this,"textntags",new TextNTags(this));return _.isFunction(instance[ms])?instance[ms].apply(this,Array.prototype.slice.call(outerArguments,1)):"object"!=typeof ms&&ms?void $.error("Method "+ms+" does not exist"):instance.init.call(this,ms)})}},{}]},{},[1])(1)});